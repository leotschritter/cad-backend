# Helm values for weather-forecast-service in shared namespace (DEV)
# This service is deployed once and shared between freemium and pro tiers

# Override namespace
namespaceOverride: shared

# Common labels applied to all resources
commonLabels:
  app.kubernetes.io/part-of: weather-forecast-system
  app.kubernetes.io/managed-by: helm
  tier: shared
  environment: dev

postgres:
  name: weather-postgres
  image: postgres:15-alpine
  port: 5432
  replicas: 1
  environmentVariables:
    database: weather_forecast
    user: weather_user
    password: weather_pass
    pgdata: /var/lib/postgresql/data/pgdata
  volumeMounts:
    mountPath: /var/lib/postgresql/data
    name: weather-postgres-storage
  readinessProbe:
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 6

postgresPvc:
  name: weather-postgres-data-pvc
  storage: 10Gi

weatherForecastApi:
  name: weather-forecast-service
  image: europe-west1-docker.pkg.dev/iaas-476910/docker-repo/weather-forecast-service:latest
  port: 8080
  replicas: 2

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "2000m"

  cors:
    origins: "*"
    methods: "GET,POST,PUT,DELETE,OPTIONS,HEAD,PATCH"
    headers: "accept,authorization,content-type,x-requested-with,origin"
    exposedHeaders: "Content-Disposition"
    allowCredentials: "true"

  quarkus:
    acquisitionTimeout: "10"
    backgroundValidationInterval: "2M"
    idleRemovalInterval: "5M"
    maxLifetime: "30M"

  probes:
    startup:
      path: /q/health/started
      initialDelaySeconds: 5
      periodSeconds: 5
      failureThreshold: 30
      timeoutSeconds: 3
    readiness:
      path: /q/health/ready
      periodSeconds: 30
      initialDelaySeconds: 5
      failureThreshold: 3
      timeoutSeconds: 5
    liveness:
      path: /q/health/live
      periodSeconds: 30
      initialDelaySeconds: 10
      failureThreshold: 3
      timeoutSeconds: 5

meteosource:
  apiKey: ""  # Set via: --set meteosource.apiKey=your-api-key

weatherForecastConfig:
  name: weather-forecast-config
  meteosource:
    sections: "daily,hourly"
    language: "en"
    units: "metric"
  db:
    url: "jdbc:postgresql://weather-postgres.shared.svc.cluster.local:5432/weather_forecast"

ingress:
  name: weather-forecast-ingress
  enabled: true
  useProd: true
  prod:
    host: ""
    tlsSecretName: ""
    sslRedirect: "true"
    forceSslRedirect: "true"

# Autoscaling configuration
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 4
  targetCPUUtilizationPercentage: 70

certificate:
  name: weather-dev-tls-cert
  secretName: weather-dev-tls
  issuerName: letsencrypt-prod  # Use staging for dev
