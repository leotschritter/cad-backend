name: Deploy Services to Multi-Namespace Architecture

on:
  push:
    branches:
      - main
      - feature/namespaces-01
    paths:
      - '.github/workflows/deploy-multi-namespace.yml'
  workflow_dispatch:
    inputs:
      tier:
        description: 'Which tier to deploy'
        required: true
        type: choice
        options:
          - all
          - freemium
          - standard
        default: all
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - prod
          - dev
        default: prod
      tenant_number:
        description: 'Tenant number for standard tier (e.g., 1, 2, 3)'
        required: false
        type: string
        default: '1'
  repository_dispatch:
    types: [deploy-multi-namespace]

jobs:
  setup-namespaces:
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch' && (inputs.environment == 'prod' && 'production' || 'develop') || github.event_name == 'repository_dispatch' && (github.event.client_payload.environment == 'prod' && 'production' || 'develop') || (github.ref_name == 'main' && 'production' || 'develop') }}
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.ref || github.ref }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install GKE Auth Plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Get GKE Credentials
        run: |
          gcloud container clusters get-credentials tripico-cluster \
            --region europe-west1 \
            --project ${{ vars.PROJECT_ID }}

      - name: Create Namespaces
        run: |
          echo "Creating namespaces..."
          kubectl apply -f infrastructure/kubernetes/namespaces/namespaces.yaml
          
          echo "Waiting for namespaces to be ready..."
          kubectl wait --for=jsonpath='{.status.phase}'=Active namespace/shared --timeout=60s
          kubectl wait --for=jsonpath='{.status.phase}'=Active namespace/freemium --timeout=60s
          kubectl wait --for=jsonpath='{.status.phase}'=Active namespace/standard --timeout=60s
          
          echo "Namespaces created successfully"

      - name: Apply Network Policies
        run: |
          echo "Applying network policies..."
          kubectl apply -f infrastructure/kubernetes/namespaces/network-policies.yaml

          echo "Network policies applied successfully"

  deploy-freemium-services:
    needs: setup-namespaces
    if: ${{ github.event_name == 'push' || github.event.client_payload.tier == 'all' || github.event.client_payload.tier == 'freemium' || inputs.tier == 'all' || inputs.tier == 'freemium' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch' && (inputs.environment == 'prod' && 'production' || 'develop') || github.event_name == 'repository_dispatch' && (github.event.client_payload.environment == 'prod' && 'production' || 'develop') || (github.ref_name == 'main' && 'production' || 'develop') }}
    permissions:
      contents: read
      id-token: write

    strategy:
      matrix:
        service:
          - name: itinerary-service
            chart: services/itinerary-service/kubernetes/itinerary-service-chart
            values_dev: services/itinerary-service/kubernetes/itinerary-service-chart/values-freemium-dev.yaml
            values_prod: services/itinerary-service/kubernetes/itinerary-service-chart/values-freemium-prod.yaml
            domain_dev: "itinerary-freemium.dev.tripico.fun"
            domain_prod: "itinerary-freemium.tripico.fun"
          - name: recommendation-service
            chart: services/recommendation-service/recommendation-service-chart
            values_dev: services/recommendation-service/recommendation-service-chart/values-freemium-dev.yaml
            values_prod: services/recommendation-service/recommendation-service-chart/values-freemium-prod.yaml
            domain_dev: "recommendation-freemium.dev.tripico.fun"
            domain_prod: "recommendation-freemium.tripico.fun"
          - name: comments-likes-service
            chart: services/comments-likes-service/comments-likes-chart
            values_dev: services/comments-likes-service/comments-likes-chart/values-freemium-dev.yaml
            values_prod: services/comments-likes-service/comments-likes-chart/values-freemium-prod.yaml
            domain_dev: "cl-freemium.dev.tripico.fun"
            domain_prod: "cl-freemium.tripico.fun"

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.ref || github.ref }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install GKE Auth Plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Get GKE Credentials
        run: |
          gcloud container clusters get-credentials tripico-cluster \
            --region europe-west1 \
            --project ${{ vars.PROJECT_ID }}

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.13.0'

      - name: Deploy ${{ matrix.service.name }} to freemium namespace
        env:
          DEPLOY_ENV: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || github.event.client_payload.environment || 'dev' }}
        run: |
          VALUES_FILE=${{ matrix.service.values_dev }}
          DOMAIN=${{ matrix.service.domain_dev }}

          if [ "$DEPLOY_ENV" = "prod" ]; then
            VALUES_FILE=${{ matrix.service.values_prod }}
            DOMAIN=${{ matrix.service.domain_prod }}
          fi

          # Build helm arguments based on service type
          HELM_ARGS="--namespace freemium --create-namespace --values $VALUES_FILE"
          HELM_ARGS="$HELM_ARGS --set database.password=${{ secrets.DB_PASSWORD }}"
          HELM_ARGS="$HELM_ARGS --set database.url=${{ secrets.DB_URL }}"
          HELM_ARGS="$HELM_ARGS --set neo4j.password=${{ secrets.NEO4J_PASSWORD }}"

          # recommendation-service uses ingress.prod.* for both dev and prod
          if [ "${{ matrix.service.name }}" = "recommendation-service" ]; then
            HELM_ARGS="$HELM_ARGS --set ingress.prod.host=$DOMAIN"
            HELM_ARGS="$HELM_ARGS --set ingress.prod.tlsSecretName=${{ matrix.service.name }}-freemium-tls"
          else
            # Other services use ingress.host
            HELM_ARGS="$HELM_ARGS --set ingress.host=$DOMAIN"
            HELM_ARGS="$HELM_ARGS --set ingress.tlsSecretName=${{ matrix.service.name }}-freemium-tls"
          fi

          helm upgrade --install ${{ matrix.service.name }}-freemium ${{ matrix.service.chart }} \
            $HELM_ARGS \
            --wait \
            --timeout 10m

  deploy-standard-services:
    needs: setup-namespaces
    if: ${{ github.event_name == 'push' || github.event.client_payload.tier == 'all' || github.event.client_payload.tier == 'standard' || inputs.tier == 'all' || inputs.tier == 'standard' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch' && (inputs.environment == 'prod' && 'production' || 'develop') || github.event_name == 'repository_dispatch' && (github.event.client_payload.environment == 'prod' && 'production' || 'develop') || (github.ref_name == 'main' && 'production' || 'develop') }}
    permissions:
      contents: read
      id-token: write

    strategy:
      matrix:
        service:
          - name: itinerary-service
            chart: services/itinerary-service/kubernetes/itinerary-service-chart
            values_dev: services/itinerary-service/kubernetes/itinerary-service-chart/values-standard-dev.yaml
            values_prod: services/itinerary-service/kubernetes/itinerary-service-chart/values-standard-prod.yaml
            domain_dev: "itinerary-standard.dev.tripico.fun"
            domain_prod: "itinerary-standard.tripico.fun"
          - name: recommendation-service
            chart: services/recommendation-service/recommendation-service-chart
            values_dev: services/recommendation-service/recommendation-service-chart/values-standard-dev.yaml
            values_prod: services/recommendation-service/recommendation-service-chart/values-standard-prod.yaml
            domain_dev: "recommendation-standard.dev.tripico.fun"
            domain_prod: "recommendation-standard.tripico.fun"
          - name: comments-likes-service
            chart: services/comments-likes-service/comments-likes-chart
            values_dev: services/comments-likes-service/comments-likes-chart/values-standard-dev.yaml
            values_prod: services/comments-likes-service/comments-likes-chart/values-standard-prod.yaml
            domain_dev: "comments-likes-standard.dev.tripico.fun"
            domain_prod: "comments-likes-standard.tripico.fun"

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.ref || github.ref }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install GKE Auth Plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Get GKE Credentials
        run: |
          gcloud container clusters get-credentials tripico-cluster \
            --region europe-west1 \
            --project ${{ vars.PROJECT_ID }}

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.13.0'

      - name: Deploy ${{ matrix.service.name }} to standard namespace
        env:
          DEPLOY_ENV: ${{ github.event_name == 'workflow_dispatch' && inputs.environment || github.event.client_payload.environment || 'dev' }}
          TENANT_NUMBER: ${{ github.event_name == 'workflow_dispatch' && inputs.tenant_number || github.event.client_payload.tenant_number || '1' }}
        run: |
          VALUES_FILE=${{ matrix.service.values_dev }}
          DOMAIN=${{ matrix.service.domain_dev }}

          if [ "$DEPLOY_ENV" = "prod" ]; then
            VALUES_FILE=${{ matrix.service.values_prod }}
            DOMAIN=${{ matrix.service.domain_prod }}
          fi

          # Build namespace with tenant number: standard-1, standard-2, etc.
          NAMESPACE="standard-${TENANT_NUMBER}"

          # Update domain to include tenant number
          DOMAIN="${DOMAIN/standard/standard-${TENANT_NUMBER}}"

          echo "Deploying to namespace: $NAMESPACE"
          echo "Domain: $DOMAIN"
          echo "Tenant number: $TENANT_NUMBER"

          # Build helm arguments
          HELM_ARGS="--namespace $NAMESPACE --create-namespace --values $VALUES_FILE"
          HELM_ARGS="$HELM_ARGS --set database.password=${{ secrets.DB_PASSWORD }}"
          HELM_ARGS="$HELM_ARGS --set database.url=${{ secrets.DB_URL }}"
          HELM_ARGS="$HELM_ARGS --set neo4j.password=${{ secrets.NEO4J_PASSWORD }}"

          # recommendation-service uses ingress.prod.* for both dev and prod
          if [ "${{ matrix.service.name }}" = "recommendation-service" ]; then
            HELM_ARGS="$HELM_ARGS --set ingress.prod.host=$DOMAIN"
            HELM_ARGS="$HELM_ARGS --set ingress.prod.tlsSecretName=${{ matrix.service.name }}-standard-${TENANT_NUMBER}-tls"
          else
            # Other services use ingress.host
            HELM_ARGS="$HELM_ARGS --set ingress.host=$DOMAIN"
            HELM_ARGS="$HELM_ARGS --set ingress.tlsSecretName=${{ matrix.service.name }}-standard-${TENANT_NUMBER}-tls"
          fi

          helm upgrade --install ${{ matrix.service.name }}-standard-${TENANT_NUMBER} ${{ matrix.service.chart }} \
            $HELM_ARGS \
            --wait \
            --timeout 10m

  verify-deployment:
    needs: [deploy-freemium-services, deploy-standard-services]
    if: |
      always() &&
      (needs.deploy-freemium-services.result == 'success' || needs.deploy-freemium-services.result == 'skipped') &&
      (needs.deploy-standard-services.result == 'success' || needs.deploy-standard-services.result == 'skipped')
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch' && (inputs.environment == 'prod' && 'production' || 'develop') || github.event_name == 'repository_dispatch' && (github.event.client_payload.environment == 'prod' && 'production' || 'develop') || (github.ref_name == 'main' && 'production' || 'develop') }}
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.ref || github.ref }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install GKE Auth Plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Get GKE Credentials
        run: |
          gcloud container clusters get-credentials tripico-cluster \
            --region europe-west1 \
            --project ${{ vars.PROJECT_ID }}

      - name: Verify Deployments
        run: |
          echo "========== SHARED NAMESPACE =========="
          kubectl get all -n shared
          echo ""
          echo "========== FREEMIUM NAMESPACE =========="
          kubectl get all -n freemium
          echo ""
          echo "========== STANDARD NAMESPACE =========="
          kubectl get all -n standard
          echo ""
          echo "========== RESOURCE QUOTAS =========="
          kubectl describe quota -n shared || echo "No quotas in shared"
          kubectl describe quota -n freemium || echo "No quotas in freemium"
          kubectl describe quota -n standard || echo "No quotas in standard"
          echo ""
          echo "========== NETWORK POLICIES =========="
          kubectl get networkpolicies --all-namespaces
