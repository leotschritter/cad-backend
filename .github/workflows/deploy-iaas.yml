name: Deploy to GCP

# Nur manuell triggern
on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY_2 }}
          project_id: ${{ secrets.GCP_PROJECT_ID_2 }}
          export_default_credentials: true

      - name: Verify gcloud authentication
        run: |
          gcloud --version
          gcloud auth list --quiet

      - name: Make deploy script executable
        run: chmod +x ./terraform/deploy.sh

      - name: Run deployment script (non-interactive in CI)
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID_2 }}
          GCP_ZONE: europe-west3-a
          VM_NAME: cad-travel-app-vm
          CI: 'true'
        run: ./terraform/deploy.sh

#      - name: Update Docker Images on VM
#        env:
#          GCP_ZONE: europe-west3-a
#          VM_NAME: cad-travel-app-vm
#        continue-on-error: false
#        run: |
#          echo "üîÑ Updating containers..."
#          gcloud compute ssh $VM_NAME \
#            --zone=$GCP_ZONE \
#            --tunnel-through-iap \
#            --command="cd /opt/cad-travel && docker-compose pull && docker-compose up -d --force-recreate" \
#            || { echo "‚ùå Failed to update images"; exit 1; }
#          echo "‚úÖ Images updated"
